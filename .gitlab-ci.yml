# YB Migration CI/CD Pipeline
# ç”¨äº MySQL åˆ° YB æ•°æ®åº“è¿ç§»å…¼å®¹æ€§åˆ†æå·¥å…·çš„æŒç»­é›†æˆå’Œéƒ¨ç½²
# é¡¹ç›®åœ°å€: gitlab.company.com/teams/yb-migration
# Go ç‰ˆæœ¬: 1.25.1
# æ”¯æŒå†…éƒ¨ GitLab ä¼ä¸šçº§ç®¡ç†

stages:
  - prepare
  - quality
  - test
  - security
  - build
  - deploy
  - notify

# ============================================================================
# å…¨å±€é…ç½®
# ============================================================================

# å…¨å±€ç¯å¢ƒå˜é‡é…ç½®
variables:
  # Go ç¯å¢ƒé…ç½®
  GO_VERSION: "1.25.1"
  GOPROXY: https://goproxy.cn,direct
  GO111MODULE: "on"
  CGO_ENABLED: 0
  APP_NAME: ybMigration
  
  # GitLab ç‰¹å®šé…ç½®
  GIT_STRATEGY: clone
  GIT_DEPTH: 0  # å®Œæ•´å…‹éš†ï¼Œç”¨äºè´¨é‡åˆ†æ
  
  # ç¼“å­˜é…ç½®
  CACHE_KEY_PREFIX: "yb-migration"
  
  # æ„å»ºé…ç½®
  BUILD_DIR: "bin"
  DOCKER_REGISTRY: "registry.gitlab.company.com"
  DOCKER_IMAGE: "${DOCKER_REGISTRY}/yb-migration/${APP_NAME}"
  
  # é€šçŸ¥é…ç½®
  NOTIFICATION_WEBHOOK: "${WEBHOOK_URL}"  # GitLab CI/CD é€šçŸ¥ webhook
  SLACK_WEBHOOK: "${SLACK_URL}"          # Slack é€šçŸ¥ webhook

# ç¼“å­˜é…ç½®ï¼ŒåŠ é€Ÿ CI æ‰§è¡Œ
cache:
  paths:
    - .cache/                    # Go æ¨¡å—ç¼“å­˜
    - .gocache/                  # Go æ„å»ºç¼“å­˜
    - vendor/                    # ä¾èµ–ç¼“å­˜
  key: "${CACHE_KEY_PREFIX}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
  untracked: true

# é»˜è®¤é…ç½®
default:
  image: golang:${GO_VERSION}
  before_script:
    - echo "ğŸš€ å¼€å§‹æ‰§è¡Œä»»åŠ¡: ${CI_JOB_NAME}"
    - echo "ğŸ“ åˆ†æ”¯: ${CI_COMMIT_REF_NAME}"
    - echo "ğŸ·ï¸  æäº¤: ${CI_COMMIT_SHORT_SHA}"
    - echo "ğŸ”— é¡¹ç›®: ${CI_PROJECT_PATH}"
    - go version
    - go env
  after_script:
    - echo "âœ… ä»»åŠ¡å®Œæˆ: ${CI_JOB_NAME}"
  tags:
    - docker
    - linux

# ============================================================================
# å‡†å¤‡é˜¶æ®µ
# ============================================================================

# ç¯å¢ƒå‡†å¤‡ä»»åŠ¡
prepare:
  stage: prepare
  script:
    - echo "ğŸ“¦ å‡†å¤‡æ„å»ºç¯å¢ƒ..."
    - mkdir -p ${BUILD_DIR}
    - mkdir -p .cache .gocache
    - go mod download
    - go mod verify
    - go mod tidy
    - echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - vendor/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop
    - /^release\/.*$/
    - /^hotfix\/.*$/

# ============================================================================
# è´¨é‡æ£€æŸ¥é˜¶æ®µ (Quality Gate)
# ============================================================================

# ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡
# ä½¿ç”¨ golangci-lint è¿›è¡Œå…¨é¢çš„é™æ€ä»£ç åˆ†æ
quality-check:
  stage: quality
  image: golangci/golangci-lint:latest
  script:
    - echo "ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
    - echo "ğŸ“‹ æ£€æŸ¥é…ç½®æ–‡ä»¶..."
    - test -f .golangci.yml || (echo "âŒ .golangci.yml é…ç½®æ–‡ä»¶ä¸å­˜åœ¨" && exit 1)
    
    # è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
    - echo "ğŸ” æ‰§è¡Œ golangci-lint æ£€æŸ¥..."
    - golangci-lint run --config .golangci.yml --timeout 15m ./...
    
    # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
    - echo "ğŸ“Š ç”Ÿæˆè´¨é‡æŠ¥å‘Š..."
    - golangci-lint run --config .golangci.yml --out-format=json --timeout 15m ./... > quality-report.json 2>/dev/null || true
    - golangci-lint run --config .golangci.yml --out-format=html --timeout 15m ./... > quality-report.html 2>/dev/null || true
    - golangci-lint run --config .golangci.yml --out-format=checkstyle --timeout 15m ./... > quality-checkstyle.xml 2>/dev/null || true
    
    # æ˜¾ç¤ºè´¨é‡ç»Ÿè®¡
    - echo "ğŸ“ˆ ä»£ç è´¨é‡ç»Ÿè®¡:"
    - golangci-lint run --config .golangci.yml --max-issues-per-linter=0 --max-same-issues=0 --timeout 15m ./... | head -20
    
    # ç”Ÿæˆè´¨é‡æŒ‡æ ‡æ–‡ä»¶
    - |
      cat > quality-metrics.json << EOF
      {
        "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
        "commit": "${CI_COMMIT_SHORT_SHA}",
        "branch": "${CI_COMMIT_REF_NAME}",
        "project": "${CI_PROJECT_PATH}",
        "pipeline": "${CI_PIPELINE_ID}",
        "job": "${CI_JOB_ID}"
      }
      EOF
    
    - echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - quality-report.json      # JSON æ ¼å¼æŠ¥å‘Š
      - quality-report.html     # HTML æ ¼å¼æŠ¥å‘Š
      - quality-checkstyle.xml  # Checkstyle æ ¼å¼æŠ¥å‘Š
      - quality-metrics.json    # è´¨é‡æŒ‡æ ‡
    expire_in: 1 week
    when: always              # å³ä½¿å¤±è´¥ä¹Ÿä¿å­˜æŠ¥å‘Š
    reports:
      junit: quality-checkstyle.xml  # GitLab é›†æˆæµ‹è¯•æŠ¥å‘Š
  coverage: '/total:.*?(\d+\.\d+)%/'
  only:
    - merge_requests
    - main
    - develop
    - /^release\/.*$/
    - /^hotfix\/.*$/
  allow_failure: false       # è´¨é‡æ£€æŸ¥å¤±è´¥æ—¶é˜»å¡æµç¨‹
  tags:
    - docker
    - quality

# ä»£ç å¤æ‚åº¦åˆ†æ
complexity-analysis:
  stage: quality
  image: golang:${GO_VERSION}
  script:
    - echo "ğŸ§® è¿è¡Œä»£ç å¤æ‚åº¦åˆ†æ..."
    
    # å®‰è£…åˆ†æå·¥å…·
    - go install github.com/fzipp/gocyclo/cmd/gocyclo@latest
    - go install github.com/psampaz/go-mod-outdated@latest
    
    # åœˆå¤æ‚åº¦åˆ†æ
    - echo "ğŸ“Š åœˆå¤æ‚åº¦åˆ†æ:"
    - gocyclo -over 12 . || echo "âœ… åœˆå¤æ‚åº¦æ£€æŸ¥é€šè¿‡"
    
    # ä¾èµ–åˆ†æ
    - echo "ğŸ“¦ ä¾èµ–åˆ†æ:"
    - go list -mod=mod -u -m -json all | go-mod-outdated -update -direct || echo "âœ… ä¾èµ–åˆ†æå®Œæˆ"
    
    # ç”Ÿæˆå¤æ‚åº¦æŠ¥å‘Š
    - |
      gocyclo -over 0 . > complexity-report.txt 2>/dev/null || true
      echo "å¤æ‚åº¦åˆ†æå®Œæˆ" > complexity-summary.txt
    
    - echo "âœ… å¤æ‚åº¦åˆ†æå®Œæˆ"
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - complexity-report.txt
      - complexity-summary.txt
    expire_in: 1 week
    when: always
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true         # å¤æ‚åº¦åˆ†æå¤±è´¥ä¸é˜»å¡æµç¨‹
  tags:
    - docker

# ä»£ç æ ¼å¼æ£€æŸ¥ä»»åŠ¡
# ç¡®ä¿ä»£ç æ ¼å¼ä¸€è‡´æ€§
format-check:
  stage: quality
  image: golang:${GO_VERSION}
  script:
    - echo "ğŸ“ æ£€æŸ¥ä»£ç æ ¼å¼..."
    
    # æ£€æŸ¥ gofmt æ ¼å¼
    - echo "ğŸ” Go æ ¼å¼æ£€æŸ¥:"
    - |
      if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
        echo "âŒ ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–:"
        gofmt -s -l .
        echo "ğŸ’¡ è¿è¡Œ 'gofmt -s -w .' ä¿®å¤æ ¼å¼é—®é¢˜"
        exit 1
      else
        echo "âœ… Go æ ¼å¼æ£€æŸ¥é€šè¿‡"
      fi
    
    # æ£€æŸ¥ goimports æ ¼å¼
    - echo "ğŸ” Import æ ¼å¼æ£€æŸ¥:"
    - |
      if command -v goimports >/dev/null 2>&1; then
        if [ "$(goimports -l . | wc -l)" -gt 0 ]; then
          echo "âŒ ä»¥ä¸‹æ–‡ä»¶çš„ import è¯­å¥éœ€è¦æ ¼å¼åŒ–:"
          goimports -l .
          echo "ğŸ’¡ è¿è¡Œ 'goimports -w .' ä¿®å¤æ ¼å¼é—®é¢˜"
          exit 1
        else
          echo "âœ… Import æ ¼å¼æ£€æŸ¥é€šè¿‡"
        fi
      else
        echo "âš ï¸  goimports æœªå®‰è£…ï¼Œè·³è¿‡ import æ ¼å¼æ£€æŸ¥"
        go install golang.org/x/tools/cmd/goimports@latest
      fi
    
    - echo "âœ… æ ¼å¼æ£€æŸ¥å®Œæˆ"
  only:
    - merge_requests
    - main
    - develop
    - /^release\/.*$/
    - /^hotfix\/.*$/
  allow_failure: false
  tags:
    - docker

# è¦†ç›–ç‡è´¨é‡é—¨ç¦
# ç¡®ä¿æµ‹è¯•è¦†ç›–ç‡ä¸ä½äºé˜ˆå€¼
coverage-gate:
  stage: quality
  image: golang:${GO_VERSION}
  script:
    - echo "ğŸ§ª è¿è¡Œè¦†ç›–ç‡æ£€æŸ¥..."
    
    # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
    - go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
    
    # æå–è¦†ç›–ç‡ç™¾åˆ†æ¯”
    - COVERAGE=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//')
    - echo "ğŸ“Š å½“å‰ä»£ç è¦†ç›–ç‡: ${COVERAGE}%"
    
    # æ£€æŸ¥è¦†ç›–ç‡æ˜¯å¦è¾¾åˆ°é˜ˆå€¼
    - |
      if (( $(echo "$COVERAGE >= 60" | bc -l) )); then
        echo "âœ… è¦†ç›–ç‡æ£€æŸ¥é€šè¿‡ (â‰¥60%)"
      else
        echo "âŒ è¦†ç›–ç‡ä¸è¾¾æ ‡ (å½“å‰: ${COVERAGE}%, è¦æ±‚: â‰¥60%)"
        exit 1
      fi
    
    # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    - go tool cover -html=coverage.txt -o coverage.html
    - echo "âœ… è¦†ç›–ç‡æ£€æŸ¥å®Œæˆ"
  coverage: '/total:.*?(\d+\.\d+)%/'
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - coverage.txt
      - coverage.html
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop
    - /^release\/.*$/
    - /^hotfix\/.*$/
  allow_failure: false
  tags:
    - docker

# ============================================================================
# æµ‹è¯•é˜¶æ®µ
# ============================================================================

# å•å…ƒæµ‹è¯•ä»»åŠ¡
# æ‰§è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•ï¼Œç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š
unit-test:
  stage: test
  script:
    - echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
    
    # è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œå¯ç”¨ç«æ€æ£€æµ‹ï¼Œç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    - go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
    
    # æ˜¾ç¤ºæµ‹è¯•è¦†ç›–ç‡æ‘˜è¦
    - go tool cover -func=coverage.txt
    
    # ç”Ÿæˆ JUnit æ ¼å¼çš„æµ‹è¯•æŠ¥å‘Š
    - go install github.com/jstemmer/go-junit-report@latest
    - go test -v -race ./... 2>&1 | go-junit-report > test-report.xml
    
    - echo "âœ… å•å…ƒæµ‹è¯•å®Œæˆ"
  coverage: '/total:.*?(\d+\.\d+)%/'
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - coverage.txt          # è¦†ç›–ç‡åŸå§‹æ•°æ®
      - test-report.xml      # JUnit æµ‹è¯•æŠ¥å‘Š
    expire_in: 1 week
    reports:
      junit: test-report.xml  # GitLab é›†æˆæµ‹è¯•æŠ¥å‘Š
  only:
    - merge_requests
    - main
    - develop
    - /^release\/.*$/
    - /^hotfix\/.*$/
  dependencies:
    - quality-check          # ä¾èµ–è´¨é‡æ£€æŸ¥é€šè¿‡
    - coverage-gate          # ä¾èµ–è¦†ç›–ç‡é—¨ç¦é€šè¿‡
  tags:
    - docker

# é›†æˆæµ‹è¯•ä»»åŠ¡
# æ‰§è¡Œé›†æˆæµ‹è¯•ï¼ŒéªŒè¯å„æ¨¡å—é—´çš„åä½œ
integration-test:
  stage: test
  script:
    - echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
    
    # è¿è¡Œé›†æˆæµ‹è¯•ï¼Œå¯ç”¨ç«æ€æ£€æµ‹
    - go test -v -race -tags=integration ./...
    
    # å¦‚æœæœ‰ç‰¹å®šçš„é›†æˆæµ‹è¯•å¥—ä»¶ï¼Œå¯ä»¥å•ç‹¬è¿è¡Œ
    - go test -v -race ./cmd/... -tags=integration
    
    - echo "âœ… é›†æˆæµ‹è¯•å®Œæˆ"
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - integration-test.log
    expire_in: 1 week
    when: always
  only:
    - merge_requests
    - main
    - develop
    - /^release\/.*$/
    - /^hotfix\/.*$/
  dependencies:
    - quality-check          # ä¾èµ–è´¨é‡æ£€æŸ¥é€šè¿‡
  tags:
    - docker

# æ€§èƒ½åŸºå‡†æµ‹è¯•
benchmark:
  stage: test
  script:
    - echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
    
    # è¿è¡ŒåŸºå‡†æµ‹è¯•
    - go test -bench=. -benchmem -run=^$$ ./... -count=3 > benchmark.txt
    
    # ç”ŸæˆåŸºå‡†æµ‹è¯•æŠ¥å‘Š
    - go install golang.org/x/perf/cmd/benchstat@latest
    - echo "åŸºå‡†æµ‹è¯•ç»“æœ:" > benchmark-summary.txt
    - cat benchmark.txt >> benchmark-summary.txt
    
    - echo "âœ… åŸºå‡†æµ‹è¯•å®Œæˆ"
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - benchmark.txt
      - benchmark-summary.txt
    expire_in: 1 week
  only:
    - main
    - develop
    - /^release\/.*$/
  allow_failure: true         # åŸºå‡†æµ‹è¯•å¤±è´¥ä¸é˜»å¡æµç¨‹
  tags:
    - docker

# ============================================================================
# å®‰å…¨é˜¶æ®µ
# ============================================================================

# å®‰å…¨æ‰«æä»»åŠ¡
# ä¸“é—¨æ£€æŸ¥å®‰å…¨æ¼æ´å’Œæ•æ„Ÿä¿¡æ¯
security-scan:
  stage: security
  image: golangci/golangci-lint:latest
  script:
    - echo "ğŸ”’ è¿è¡Œå®‰å…¨æ‰«æ..."
    
    # è¿è¡Œå®‰å…¨æ£€æŸ¥
    - echo "ğŸ›¡ï¸ å®‰å…¨æ¼æ´æ‰«æ:"
    - golangci-lint run --config .golangci.yml --enable-only=gosec --timeout 10m ./...
    
    # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²
    - echo "ğŸ” æ•æ„Ÿä¿¡æ¯æ£€æŸ¥:"
    - |
      if grep -r -i "password\|secret\|key\|token" --include="*.go" --include="*.yaml" --include="*.yml" --exclude-dir=.git . 2>/dev/null; then
        echo "âš ï¸ è­¦å‘Š: å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯"
        echo "::warning::å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²"
      else
        echo "âœ… æœªå‘ç°æ˜æ˜¾çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²"
      fi
    
    # æ£€æŸ¥ä¾èµ–æ¼æ´
    - echo "ğŸ“¦ ä¾èµ–å®‰å…¨æ£€æŸ¥:"
    - |
      go install github.com/sonatypecommunity/nancy/cmd/nancy@latest
      go list -json -m all | nancy sleuth || echo "nancy å·¥å…·æ£€æŸ¥å¤±è´¥"
    
    # ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
    - echo "å®‰å…¨æ‰«æå®Œæˆ" > security-report.txt
    
    - echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - security-report.log
    expire_in: 1 week
    when: always
  only:
    - merge_requests
    - main
    - develop
    - /^release\/.*$/
    - /^hotfix\/.*$/
  allow_failure: true         # å®‰å…¨æ‰«æå¤±è´¥ä¸é˜»å¡æµç¨‹ï¼Œä½†ä¼šå‘å‡ºè­¦å‘Š
  tags:
    - docker
    - security

# å•å…ƒæµ‹è¯•ä»»åŠ¡
# æ‰§è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•ï¼Œç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š
unit-test:
  stage: test
  script:
    # è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œå¯ç”¨ç«æ€æ£€æµ‹ï¼Œç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    - go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
    # æ˜¾ç¤ºæµ‹è¯•è¦†ç›–ç‡æ‘˜è¦
    - go tool cover -func=coverage.txt
  coverage: '/total:.*?(\d+\.\d+)%/' # æå–æ€»è¦†ç›–ç‡
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - coverage.txt          # è¦†ç›–ç‡åŸå§‹æ•°æ®
    expire_in: 1 week
  only:
    - merge_requests          # åœ¨åˆå¹¶è¯·æ±‚ä¸­è¿è¡Œ
    - main                   # åœ¨ä¸»åˆ†æ”¯ä¸Šè¿è¡Œ
  dependencies:
    - quality-check          # ä¾èµ–è´¨é‡æ£€æŸ¥é€šè¿‡
    - coverage-gate          # ä¾èµ–è¦†ç›–ç‡é—¨ç¦é€šè¿‡
  tags:
    - docker                 # ä½¿ç”¨ Docker æ‰§è¡Œå™¨

# é›†æˆæµ‹è¯•ä»»åŠ¡
# æ‰§è¡Œé›†æˆæµ‹è¯•ï¼ŒéªŒè¯å„æ¨¡å—é—´çš„åä½œ
integration-test:
  stage: test
  script:
    # è¿è¡Œé›†æˆæµ‹è¯•ï¼Œå¯ç”¨ç«æ€æ£€æµ‹
    - go test -v -race -tags=integration ./...
    # å¦‚æœæœ‰ç‰¹å®šçš„é›†æˆæµ‹è¯•å¥—ä»¶ï¼Œå¯ä»¥å•ç‹¬è¿è¡Œ
    - go test -v -race ./cmd/... -tags=integration
  only:
    - merge_requests
    - main
  dependencies:
    - quality-check          # ä¾èµ–è´¨é‡æ£€æŸ¥é€šè¿‡
  tags:
    - docker

# ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡ï¼ˆè½»é‡çº§ï¼Œç”¨äºå¿«é€Ÿåé¦ˆï¼‰
# åœ¨åˆå¹¶è¯·æ±‚ä¸­æä¾›å¿«é€Ÿçš„è´¨é‡åé¦ˆ
lint:
  stage: test
  image: golangci/golangci-lint:latest
  script:
    # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    - test -f .golangci.yml || echo "è­¦å‘Š: .golangci.yml é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
    # è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥ï¼ˆä»…å…³é”®é—®é¢˜ï¼‰
    - golangci-lint run --config .golangci.yml --disable=godot,whitespace --timeout 10m ./...
    # ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
    - golangci-lint run --config .golangci.yml --out-format=json --timeout 10m ./... > lint-report.json 2>/dev/null || true
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - lint-report.json      # Lint æ£€æŸ¥æŠ¥å‘Š
    expire_in: 1 week
    when: always              # å³ä½¿å¤±è´¥ä¹Ÿä¿å­˜æŠ¥å‘Š
  only:
    - merge_requests
    - main
  dependencies:
    - quality-check          # ä¾èµ–è´¨é‡æ£€æŸ¥é€šè¿‡
  allow_failure: true         # å…è®¸å¤±è´¥ï¼Œä½†ä¸é˜»å¡æµç¨‹
  tags:
    - docker

# åº”ç”¨æ„å»ºä»»åŠ¡
# ç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ”¯æŒå¤šå¹³å°æ„å»º
build:
  stage: build
  script:
    # åˆ›å»ºæ„å»ºè¾“å‡ºç›®å½•
    - mkdir -p bin
    # æ„å»ºä¸»ç¨‹åºï¼Œä½¿ç”¨é¡¹ç›®å˜é‡ä¸­çš„ APP_NAME
    - go build -ldflags="-w -s" -o bin/${APP_NAME} ./cmd
    # æ˜¾ç¤ºæ„å»ºä¿¡æ¯
    - ls -la bin/
    - file bin/${APP_NAME}
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - bin/                   # æ„å»ºäº§ç‰©ç›®å½•
    expire_in: 1 week
  only:
    - tags                    # ä»…åœ¨æ ‡ç­¾æ¨é€æ—¶æ„å»º
    - main                    # ä¸»åˆ†æ”¯åˆå¹¶æ—¶æ„å»º
  dependencies:
    - unit-test               # ä¾èµ–æµ‹è¯•é€šè¿‡
    - integration-test
  tags:
    - docker

# ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡
# ä½¿ç”¨ golangci-lint è¿›è¡Œé™æ€ä»£ç åˆ†æ
lint:
  stage: test
  image: golangci/golangci-lint:latest  # ä½¿ç”¨å®˜æ–¹é•œåƒ
  script:
    # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    - test -f .golangci.yml || echo "è­¦å‘Š: .golangci.yml é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
    # è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
    - golangci-lint run --config .golangci.yml --timeout 5m ./...
    # ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Šï¼ˆå¯é€‰ï¼‰
    - golangci-lint run --config .golangci.yml --out-format=json > lint-report.json 2>/dev/null || true
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - lint-report.json      # Lint æ£€æŸ¥æŠ¥å‘Š
    expire_in: 1 week
    when: always              # å³ä½¿å¤±è´¥ä¹Ÿä¿å­˜æŠ¥å‘Š
  only:
    - merge_requests
    - main
  allow_failure: true         # å…è®¸å¤±è´¥ï¼Œä½†ä¸é˜»å¡æµç¨‹
  tags:
    - docker

# æ€§èƒ½åŸºå‡†æµ‹è¯•ä»»åŠ¡
# å®šæœŸè¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œç›‘æ§æ€§èƒ½å˜åŒ–
benchmark:
  stage: test
  script:
    # è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œè¾“å‡ºå†…å­˜åˆ†é…ä¿¡æ¯
    - go test -bench=. -benchmem -run=^$ ./...
    # ä¿å­˜åŸºå‡†æµ‹è¯•ç»“æœ
    - go test -bench=. -benchmem -run=^$ ./... -count=3 > benchmark.txt
    # å¦‚æœæœ‰å†å²æ•°æ®ï¼Œè¿›è¡Œå¯¹æ¯”
    - echo "åŸºå‡†æµ‹è¯•å®Œæˆï¼Œç»“æœä¿å­˜è‡³ benchmark.txt"
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - benchmark.txt          # åŸºå‡†æµ‹è¯•ç»“æœ
    expire_in: 1 month
  only:
    - schedules               # å®šæ—¶ä»»åŠ¡è§¦å‘
    - main                    # æ‰‹åŠ¨åœ¨ä¸»åˆ†æ”¯è¿è¡Œ
  when: manual                # æ‰‹åŠ¨è§¦å‘ï¼Œé¿å…é¢‘ç¹è¿è¡Œ
  tags:
    - docker

# å®‰å…¨æ‰«æä»»åŠ¡
# æ£€æŸ¥ä¾èµ–åŒ…çš„å®‰å…¨æ¼æ´
security-scan:
  stage: test
  script:
    # ä½¿ç”¨ go list æ£€æŸ¥å·²çŸ¥æ¼æ´
    - go list -json -m all | nancy sleuth
    # æˆ–ä½¿ç”¨ govulncheckï¼ˆéœ€è¦å•ç‹¬å®‰è£…ï¼‰
    # - go install golang.org/x/vuln/cmd/govulncheck@latest
    # - govulncheck ./...
  allow_failure: true         # å®‰å…¨æ‰«æå¤±è´¥ä¸é˜»å¡æµç¨‹
  only:
    - main
    - tags
  when: manual
  tags:
    - docker

# é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²
# å°†ä¸»åˆ†æ”¯ä»£ç éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒè¿›è¡ŒéªŒè¯
deploy-staging:
  stage: deploy
  script:
    - echo "å¼€å§‹éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ..."
    # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬
    # ä¾‹å¦‚ï¼šDocker éƒ¨ç½²ã€K8s éƒ¨ç½²ã€æˆ–ç›´æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨
    # docker build -t yb-migration:staging .
    # docker push registry.example.com/yb-migration:staging
    # kubectl set image deployment/yb-migration yb-migration=registry.example.com/yb-migration:staging -n staging
    - echo "é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²å®Œæˆ"
  environment:
    name: staging
    url: https://staging.example.com  # é¢„å‘å¸ƒç¯å¢ƒåœ°å€
    on_stop: stop-staging            # åœæ­¢ç¯å¢ƒä»»åŠ¡
  only:
    - main                          # ä»…ä¸»åˆ†æ”¯å¯éƒ¨ç½²åˆ°é¢„å‘å¸ƒ
  when: manual                      # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  dependencies:
    - build                         # ä¾èµ–æ„å»ºäº§ç‰©
  tags:
    - docker

# åœæ­¢é¢„å‘å¸ƒç¯å¢ƒ
stop-staging:
  stage: deploy
  script:
    - echo "åœæ­¢é¢„å‘å¸ƒç¯å¢ƒ..."
    # æ·»åŠ åœæ­¢ç¯å¢ƒçš„è„šæœ¬
    # kubectl delete deployment yb-migration -n staging
    - echo "é¢„å‘å¸ƒç¯å¢ƒå·²åœæ­¢"
  environment:
    name: staging
    action: stop
  only:
    - main
  when: manual
  tags:
    - docker

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
# ä»…åœ¨å‘å¸ƒæ ‡ç­¾æ—¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
deploy-prod:
  stage: deploy
  script:
    - echo "å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
    # éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å‘å¸ƒæ ‡ç­¾
    - if [[ ! $CI_COMMIT_TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then echo "æ— æ•ˆçš„ç‰ˆæœ¬æ ‡ç­¾æ ¼å¼ï¼Œåº”ä¸º v.x.y.z"; exit 1; fi
    # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬
    # docker build -t yb-migration:${CI_COMMIT_TAG} .
    # docker tag yb-migration:${CI_COMMIT_TAG} registry.example.com/yb-migration:latest
    # docker push registry.example.com/yb-migration:${CI_COMMIT_TAG}
    # docker push registry.example.com/yb-migration:latest
    # kubectl set image deployment/yb-migration yb-migration=registry.example.com/yb-migration:${CI_COMMIT_TAG} -n production
    - echo "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼Œç‰ˆæœ¬: ${CI_COMMIT_TAG}"
  environment:
    name: production
    url: https://example.com     # ç”Ÿäº§ç¯å¢ƒåœ°å€
  only:
    - tags                       # ä»…åœ¨æ ‡ç­¾æ¨é€æ—¶è§¦å‘
  when: manual                   # æ‰‹åŠ¨ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§
  dependencies:
    - build                      # ä¾èµ–æ„å»ºäº§ç‰©
  before_script:
    # ç”Ÿäº§ç¯å¢ƒé¢å¤–çš„å®‰å…¨æ£€æŸ¥
    - echo "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰å®‰å…¨æ£€æŸ¥..."
    # å¯ä»¥æ·»åŠ é¢å¤–çš„å®‰å…¨æ‰«ææˆ–éªŒè¯æ­¥éª¤
  tags:
    - docker

# å‘å¸ƒä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
# åˆ›å»º GitHub Release æˆ–å…¶ä»–å‘å¸ƒæ“ä½œ
release:
  stage: deploy
  script:
    - echo "åˆ›å»ºå‘å¸ƒ ${CI_COMMIT_TAG}..."
    # ä½¿ç”¨æ„å»ºäº§ç‰©åˆ›å»ºå‘å¸ƒ
    # å¯ä»¥é›†æˆ GitHub CLI æˆ–å…¶ä»–å‘å¸ƒå·¥å…·
    # gh release create ${CI_COMMIT_TAG} --title "Release ${CI_COMMIT_TAG}" --notes "è‡ªåŠ¨å‘å¸ƒ" bin/*
    - echo "å‘å¸ƒåˆ›å»ºå®Œæˆ"
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - bin/                    # å‘å¸ƒäºŒè¿›åˆ¶æ–‡ä»¶
    expire_in: never            # æ°¸ä¹…ä¿å­˜å‘å¸ƒäº§ç‰©
  only:
    - tags
  when: manual
  dependencies:
    - build
  tags:
    - docker

# æ¸…ç†ä»»åŠ¡
# å®šæœŸæ¸…ç†è¿‡æœŸçš„ CI äº§ç‰©å’Œç¼“å­˜
cleanup:
  stage: deploy
  script:
    - echo "æ¸…ç†è¿‡æœŸ CI äº§ç‰©..."
    # GitLab æœ‰è‡ªåŠ¨æ¸…ç†æœºåˆ¶ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰æ¸…ç†é€»è¾‘
    - echo "æ¸…ç†å®Œæˆ"
  only:
    - schedules
  when: manual
  tags:
    - docker
