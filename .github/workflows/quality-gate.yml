name: Quality Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  GO_VERSION: '1.25.1'
  APP_NAME: ybMigration

jobs:
  # ============================================================================
  # è´¨é‡æ£€æŸ¥é˜¶æ®µ (Quality Gate)
  # ============================================================================
  
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      quality-status: ${{ steps.quality.outcome }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go çŽ¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: ç¼“å­˜ Go æ¨¡å—
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: ä¸‹è½½ä¾èµ–
      run: |
        go mod download
        go mod verify
        
    - name: å®‰è£… golangci-lint
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        args: --timeout 15m
        
    - name: è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
      id: quality
      run: |
        echo "ðŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
        if [ ! -f .golangci.yml ]; then
          echo "âŒ é”™è¯¯: .golangci.yml é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # è¿è¡Œè´¨é‡æ£€æŸ¥
        golangci-lint run --config .golangci.yml --timeout 15m ./...
        
        # ç”ŸæˆæŠ¥å‘Š
        golangci-lint run --config .golangci.yml --out-format=json --timeout 15m ./... > quality-report.json
        golangci-lint run --config .golangci.yml --out-format=html --timeout 15m ./... > quality-report.html
        
        echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
        
    - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: quality-reports
        path: |
          quality-report.json
          quality-report.html
        retention-days: 7

  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go çŽ¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: å®‰è£… golangci-lint
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        args: --timeout 10m
        
    - name: è¿è¡Œå®‰å…¨æ‰«æ
      run: |
        echo "ðŸ”’ è¿è¡Œå®‰å…¨æ‰«æ..."
        golangci-lint run --config .golangci.yml --enable-only=gosec --timeout 10m ./...
        
        echo "ðŸ” æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²..."
        if grep -r -i "password\|secret\|key\|token" --include="*.go" --include="*.yaml" --include="*.yml" --exclude-dir=.git . 2>/dev/null; then
          echo "âš ï¸ è­¦å‘Š: å‘çŽ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯"
          echo "::warning::å‘çŽ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²"
        else
          echo "âœ… æœªå‘çŽ°æ•æ„Ÿä¿¡æ¯æ³„éœ²"
        fi
        
    - name: ä¾èµ–å®‰å…¨æ£€æŸ¥
      run: |
        echo "ðŸ” æ£€æŸ¥ä¾èµ–å®‰å…¨..."
        go list -json -m all | nancy sleuth || echo "nancy å·¥å…·æ£€æŸ¥å¤±è´¥"

  format-check:
    name: ä»£ç æ ¼å¼æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go çŽ¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: æ£€æŸ¥ Go æ ¼å¼
      run: |
        echo "ðŸ“ æ£€æŸ¥ä»£ç æ ¼å¼..."
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "âŒ ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–:"
          gofmt -s -l .
          echo "ðŸ’¡ è¿è¡Œ 'gofmt -s -w .' ä¿®å¤æ ¼å¼é—®é¢˜"
          exit 1
        else
          echo "âœ… Go æ ¼å¼æ£€æŸ¥é€šè¿‡"
        fi
        
    - name: æ£€æŸ¥ Import æ ¼å¼
      run: |
        echo "ðŸ“ æ£€æŸ¥ Import æ ¼å¼..."
        go install golang.org/x/tools/cmd/goimports@latest
        if [ "$(goimports -l . | wc -l)" -gt 0 ]; then
          echo "âŒ ä»¥ä¸‹æ–‡ä»¶çš„ import è¯­å¥éœ€è¦æ ¼å¼åŒ–:"
          goimports -l .
          echo "ðŸ’¡ è¿è¡Œ 'goimports -w .' ä¿®å¤æ ¼å¼é—®é¢˜"
          exit 1
        else
          echo "âœ… Import æ ¼å¼æ£€æŸ¥é€šè¿‡"
        fi

  coverage-gate:
    name: è¦†ç›–çŽ‡é—¨ç¦
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go çŽ¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–çŽ‡
      run: |
        echo "ðŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š..."
        go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
        
        # æå–è¦†ç›–çŽ‡ç™¾åˆ†æ¯”
        COVERAGE=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//')
        echo "å½“å‰ä»£ç è¦†ç›–çŽ‡: ${COVERAGE}%"
        
        # æ£€æŸ¥è¦†ç›–çŽ‡æ˜¯å¦è¾¾åˆ°é˜ˆå€¼
        if (( $(echo "$COVERAGE >= 60" | bc -l) )); then
          echo "âœ… è¦†ç›–çŽ‡æ£€æŸ¥é€šè¿‡ (â‰¥60%)"
        else
          echo "âŒ è¦†ç›–çŽ‡ä¸è¾¾æ ‡ (å½“å‰: ${COVERAGE}%, è¦æ±‚: â‰¥60%)"
          exit 1
        fi
        
    - name: ä¸Šä¼ è¦†ç›–çŽ‡åˆ° Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.txt
        flags: unittests
        name: codecov-umbrella

  # ============================================================================
  # æµ‹è¯•é˜¶æ®µ
  # ============================================================================
  
  unit-test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [quality-check, coverage-gate]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go çŽ¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        echo "ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
        go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
        go tool cover -func=coverage.txt
        
    - name: ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: coverage-reports
        path: coverage.txt
        retention-days: 7

  integration-test:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go çŽ¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        echo "ðŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
        go test -v -race -tags=integration ./...
        go test -v -race ./cmd/... -tags=integration

  # ============================================================================
  # æž„å»ºé˜¶æ®µ
  # ============================================================================
  
  build:
    name: æž„å»ºåº”ç”¨
    runs-on: ubuntu-latest
    needs: [unit-test, integration-test]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Go çŽ¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: æž„å»ºåº”ç”¨
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        echo "ðŸ—ï¸ æž„å»º ${{ matrix.goos }}/${{ matrix.goarch }}..."
        mkdir -p bin
        
        if [ "${{ matrix.goos }}" = "windows" ]; then
          go build -ldflags="-w -s" -o bin/${{ env.APP_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }}.exe ./cmd
        else
          go build -ldflags="-w -s" -o bin/${{ env.APP_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }} ./cmd
        fi
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.APP_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }}
        path: bin/
        retention-days: 30

  # ============================================================================
  # å‘å¸ƒé˜¶æ®µ
  # ============================================================================
  
  release:
    name: åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: |
          **/bin/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # è´¨é‡é—¨ç¦æ€»ç»“
  # ============================================================================
  
  quality-summary:
    name: è´¨é‡é—¨ç¦æ€»ç»“
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan, format-check, coverage-gate, unit-test, integration-test]
    if: always()
    
    steps:
    - name: è´¨é‡é—¨ç¦çŠ¶æ€
      run: |
        echo "## ðŸš€ è´¨é‡é—¨ç¦çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ä»£ç è´¨é‡æ£€æŸ¥ | ${{ contains(needs.quality-check.result, 'success') && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| å®‰å…¨æ‰«æ | ${{ contains(needs.security-scan.result, 'success') && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| æ ¼å¼æ£€æŸ¥ | ${{ contains(needs.format-check.result, 'success') && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| è¦†ç›–çŽ‡é—¨ç¦ | ${{ contains(needs.coverage-gate.result, 'success') && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| å•å…ƒæµ‹è¯• | ${{ contains(needs.unit-test.result, 'success') && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| é›†æˆæµ‹è¯• | ${{ contains(needs.integration-test.result, 'success') && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.quality-check.result }}" == "success" && "${{ needs.format-check.result }}" == "success" && "${{ needs.coverage-gate.result }}" == "success" && "${{ needs.unit-test.result }}" == "success" && "${{ needs.integration-test.result }}" == "success" ]]; then
          echo "ðŸŽ‰ **æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡ï¼ä»£ç å¯ä»¥åˆå¹¶ã€‚**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **è´¨é‡æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤é—®é¢˜åŽé‡æ–°æäº¤ã€‚**" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
